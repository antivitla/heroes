<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°–æ–±–∏—Ä–∞—Ç–µ–ª—å –≥–µ—Ä–æ–µ–≤</title>
  <link href="assets/collector/styles.css" rel="stylesheet">
  <script src="assets/lib/uuidv1.min.js"></script>
  <script src="assets/lib/vue3.js"></script>
  <script src="assets/lib/d3@7.js"></script>
  <script src="assets/lib/telegram.js"></script>
</head>
<body>

  <header>
    <h1>–°–æ–±–∏—Ä–∞—Ç–µ–ª—å –≥–µ—Ä–æ–µ–≤</h1>
    <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–±–æ—Ä–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–µ—Ä–æ—è—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –≤–æ–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏&nbsp;Z –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –Ω–µ–π –ª—é–±–æ–º—É –∂–µ–ª–∞—é—â–µ–º—É. –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –≤ <a href="data/heroes.json" target="_blank">data/heroes.json</a></p>
  </header>

  <p>–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:</p>

  <ul>
    <li>–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö &mdash; –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, C–∞–π—Ç –ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã z.mil.ru, –¢–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª "–†–∞–±–æ—Ç–∞–µ–º, –±—Ä–∞—Ç!", –°–∞–π—Ç warheroes, –í–∏–∫–∏–ø–µ–¥–∏—è/Megabook, –∏ —Ç.–¥.) –≤ <strong>data/sources/*</strong></li>
    <li>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏ –≤ <strong>data/heroes.json</strong> —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ –≤ <strong>data/images/*</strong>.</li>
  </ul>

  <main id="app">
    <component-selector :tabs="resource.tabs" v-model="resource.current"></component-selector>

    <keep-alive>
      <component
        :is="currentResourceComponent"
        :resource-key="resource.current"
        :heroes="heroes"
        :channel="currentResourceChannel"
        :channel-title="currentResourceChannelTitle"
        @create-hero="createHero"
        @update-heroes="updateHeroes"
      ></component>
    </keep-alive>

    <component-modals :modals="modals" @close="closeModal"></component-modals>
  </main>

  <script type="module">
    import { getJsonDocument, saveJsonDocument } from './assets/collector/utils.resource.js';
    import ComponentSelector from './assets/collector/component.selector.js';
    import ComponentModals from './assets/collector/component.modals.js';

    import ComponentResourceZmil from './assets/collector/component.resource.zmil.js';
    import ComponentResourceWarheroes from './assets/collector/component.resource.warheroes.js';
    import ComponentResourceTsargrad from './assets/collector/component.resource.tsargrad.js';
    import ComponentResourceKontingent from './assets/collector/component.resource.kontingent.js';
    import ComponentResourceTelegram from './assets/collector/component.resource.telegram.js';

    import ComponentResourceHeroes from './assets/collector/component.resource.heroes.js';
    import ComponentResourceBriefings from './assets/collector/component.resource.briefings.js';
    import ComponentResourceAwards from './assets/collector/component.resource.awards.js';

    const app = Vue.createApp({
      components: {
        ComponentSelector,
        ComponentModals,
        ComponentResourceZmil,
        ComponentResourceWarheroes,
        ComponentResourceTsargrad,
        ComponentResourceKontingent,
        ComponentResourceTelegram,
        ComponentResourceHeroes,
        ComponentResourceBriefings,
        ComponentResourceAwards,
      },
      data () {
        return {
          resource: {
            tabs: [
              { key: 'zmil', label: '–ì–µ—Ä–æ–∏ Z', sublabel: 'z.mil.ru' },
              { key: 'warheroes', label: '–ì–µ—Ä–æ–∏ –†–æ—Å—Å–∏–∏', sublabel: 'warheroes.ru' },
              { key: 'tsargrad', label: '–ù–∞—à–∏ –≥–µ—Ä–æ–∏', sublabel: 'ug.tsargrad.tv' },
              { key: 'kontingent', label: '–ì–µ—Ä–æ–∏ Z', sublabel: 'kontingent.press' },
              { key: 'telegram.rabotaembrat', label: '–†–∞–±–æ—Ç–∞–µ–º, –ë—Ä–∞—Ç! üá∑üá∫', sublabel: '@rabotaembrat' },
              { key: 'telegram.zakharprilepin', label: '–ó–∞—Ö–∞—Ä –ü—Ä–∏–ª–µ–ø–∏–Ω', sublabel: '@zakharprilepin' },
              { key: 'telegram.mod_russia', label: '–ú–∏–Ω–æ–±–æ—Ä–æ–Ω—ã –†–æ—Å—Å–∏–∏', sublabel: '@mod_russia' },
              { key: 'briefings', label: '–ë—Ä–∏—Ñ–∏–Ω–≥–∏', sublabel: 'z.mil.ru', group: 'right' },
              // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ
              // { key: 'awards', label: '–ù–∞–≥—Ä–∞–¥—ã', sublabel: 'wikipedia.org', group: 'right' },
              { key: 'heroes', label: '–ü—Ä–æ–≤–µ—Ä–∫–∞', sublabel: 'heroes.json', group: 'right' }
            ],
            current: location.hash.replace('#', '') || 'zmil'
          },
          heroes: {},
          modals: [],
        };
      },
      provide () {
        return {
          confirm: this.openConfirm
        };
      },
      watch: {
        'resource.current' (value) {
          location.hash = value;
        },
      },
      computed: {
        currentResourceComponent () {
          return `component-resource-${this.resource.current.split(/\./)[0]}`;
        },
        currentResourceChannel () {
          return this.resource.current.split(/\./)[1];
        },
        currentResourceChannelTitle () {
          return this.resource.tabs.find(tab => this.resource.current === tab.key).label;
        },
      },
      async created () {
        await this.getHeroes();
      },
      methods: {
        async getHeroes () {
          this.heroes = await getJsonDocument('data/heroes.json');
        },
        async saveHeroes () {
          await saveJsonDocument('data/heroes.json', this.heroes);
        },
        async createHero (name) {
          if (this.heroes[name]) {
            alert('–£–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π –≥–µ—Ä–æ–π');
            return;
          }
          this.heroes[name] = { name };
          await this.saveHeroes();
        },
        async updateHeroes (heroes) {
          Object.keys(heroes).forEach(name => {
            if (!this.heroes[name]) {
              this.heroes[name] = { name };
            }
            Object.assign(this.heroes[name], heroes[name]);
          });
          await this.saveHeroes();
        },

        // Modals

        async openConfirm ({ body, header } = {}) {
          return this.openModal({ type: 'confirm', body, header });
        },
        async openModal ({ type, body, header } = {}) {
          return new Promise((resolve, reject) => {
            this.modals.push({ type, body, header, resolve, reject });
          });
        },
        closeModal () {
          this.modals.pop();
        }
      }
    }).mount('#app');
  </script>

</body>
</html>